name: ğŸ—„ï¸ Database Migrations

on:
  push:
    paths:
      - 'migrations/V*.sql'
      - 'manifests/flyway-*.yaml'
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
      force_restart:
        description: 'Force restart Express after migration'
        required: false
        default: true
        type: boolean

env:
  KUBECONFIG_FILE: ${{ secrets.KUBECONFIG }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      migrations-changed: ${{ steps.changes.outputs.migrations }}
      environment: ${{ steps.env.outputs.target }}
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Detect migration changes
      id: changes
      run: |
        echo "ğŸ” Checking for migration changes..."
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ”§ Manual trigger - assuming migrations need deployment"
          echo "migrations=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
          echo "âœ… First commit - checking for migration files"
          MIGRATION_COUNT=$(find migrations/ -name "V*.sql" | wc -l)
          if [ "$MIGRATION_COUNT" -gt 0 ]; then
            echo "migrations=true" >> $GITHUB_OUTPUT
            echo "ğŸ“„ Found $MIGRATION_COUNT migration files"
          else
            echo "migrations=false" >> $GITHUB_OUTPUT
          fi
          exit 0
        fi
        
        # Check for migration file changes
        MIGRATION_CHANGES=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -E "^migrations/V.*\.sql$|^manifests/flyway-.*\.yaml$" | wc -l)
        
        if [ "$MIGRATION_CHANGES" -eq 0 ]; then
          echo "ğŸš« No migration changes detected"
          echo "migrations=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… Migration changes detected:"
          git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -E "^migrations/V.*\.sql$|^manifests/flyway-.*\.yaml$"
          echo "migrations=true" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ¯ Determine target environment
      id: env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "target=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "target=prod" >> $GITHUB_OUTPUT
        elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          echo "target=dev" >> $GITHUB_OUTPUT
        else
          echo "target=dev" >> $GITHUB_OUTPUT
        fi

  validate-migrations:
    needs: detect-changes
    if: needs.detect-changes.outputs.migrations-changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§ª Validate migration files
      run: |
        echo "ğŸ” Validating migration files..."
        
        # Install PostgreSQL client for syntax validation
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
        # Check that migrations follow naming convention
        echo "ğŸ“ Checking migration naming conventions..."
        for migration in migrations/V*.sql; do
          if [ -f "$migration" ]; then
            filename=$(basename "$migration")
            if [[ ! "$filename" =~ ^V[0-9]+__[a-zA-Z0-9_]+\.sql$ ]]; then
              echo "âŒ Invalid migration filename: $filename"
              echo "   Expected format: V{number}__{description}.sql"
              exit 1
            fi
            echo "âœ… $filename - naming convention OK"
          fi
        done
        
        # Check for duplicate version numbers
        echo "ğŸ”¢ Checking for duplicate version numbers..."
        VERSIONS=$(ls migrations/V*.sql | sed 's/.*V\([0-9]*\)__.*/\1/' | sort)
        UNIQUE_VERSIONS=$(echo "$VERSIONS" | uniq)
        if [ "$(echo "$VERSIONS" | wc -l)" != "$(echo "$UNIQUE_VERSIONS" | wc -l)" ]; then
          echo "âŒ Duplicate migration version numbers found!"
          echo "Versions: $VERSIONS"
          exit 1
        fi
        echo "âœ… All migration versions are unique"
        
        # Basic SQL syntax validation
        echo "ğŸ“ Basic SQL syntax validation..."
        for migration in migrations/V*.sql; do
          if [ -f "$migration" ]; then
            echo "ğŸ” Checking: $migration"
            # Check for common SQL issues
            if grep -q "DROP TABLE.*IF EXISTS" "$migration"; then
              echo "âš ï¸  Warning: $migration contains DROP TABLE IF EXISTS"
            fi
            if grep -q "DROP COLUMN.*IF EXISTS" "$migration"; then
              echo "âœ… $migration safely uses DROP COLUMN IF EXISTS"
            fi
            echo "âœ… $migration syntax appears valid"
          fi
        done

  deploy-dev:
    needs: [detect-changes, validate-migrations]
    if: needs.detect-changes.outputs.migrations-changed == 'true' && needs.detect-changes.outputs.environment == 'dev'
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup kubectl and doctl
      run: |
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Install doctl
        cd /tmp
        wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
        tar xf doctl-1.104.0-linux-amd64.tar.gz
        sudo mv doctl /usr/local/bin
        
        # Authenticate and configure kubectl
        doctl auth init --access-token ${{ secrets.DO_API_TOKEN }}
        doctl kubernetes cluster kubeconfig save discbaboons-production

    - name: ğŸ“Š Pre-migration status
      run: |
        echo "ğŸ“Š Current DEV environment status:"
        echo "================================="
        kubectl get pods -l app=postgres --no-headers || echo "No postgres pods found"
        echo ""
        echo "ğŸ“‹ Current migrations ConfigMap:"
        kubectl get configmap flyway-migrations -o yaml | grep -A 5 "data:" || echo "No migrations ConfigMap found"

    - name: ğŸ—„ï¸ Update migrations ConfigMap
      run: |
        echo "ğŸ“¦ Regenerating migrations ConfigMap from source files..."
        
        # Delete existing ConfigMap
        kubectl delete configmap flyway-migrations --ignore-not-found=true
        
        # Create new ConfigMap from migrations directory
        kubectl create configmap flyway-migrations --from-file=migrations/
        
        echo "âœ… ConfigMap updated with all migration files"
        echo "ğŸ“‹ ConfigMap contents:"
        kubectl get configmap flyway-migrations -o yaml | grep -A 10 "data:"

    - name: ğŸš€ Deploy Flyway migration job
      run: |
        echo "ğŸš€ Deploying Flyway migration job in DEV..."
        
        # Create Flyway migration job
        cat << 'EOF' | kubectl apply -f -
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: flyway-migration-$(date +%s)
          labels:
            app: flyway
            environment: dev
            migration-run: "true"
        spec:
          ttlSecondsAfterFinished: 600
          template:
            metadata:
              labels:
                app: flyway
                environment: dev
            spec:
              restartPolicy: Never
              containers:
              - name: flyway
                image: flyway/flyway:10.8.1
                command: ["/bin/sh"]
                args:
                  - -c
                  - |
                    echo "ğŸ” Migration files in container:"
                    ls -la /flyway/sql/
                    echo ""
                    echo "ğŸš€ Running Flyway migrate in DEV environment..."
                    flyway migrate
                    echo ""
                    echo "ğŸ“Š Migration status:"
                    flyway info
                env:
                - name: FLYWAY_URL
                  value: "jdbc:postgresql://postgres-service:5432/discbaboons_db"
                - name: FLYWAY_USER
                  value: "app_user"
                - name: FLYWAY_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: app-password
                - name: FLYWAY_LOCATIONS
                  value: "filesystem:/flyway/sql"
                - name: FLYWAY_BASELINE_ON_MIGRATE
                  value: "true"
                volumeMounts:
                - name: migrations
                  mountPath: /flyway/sql
              volumes:
              - name: migrations
                configMap:
                  name: flyway-migrations
        EOF
        
        echo "â³ Waiting for migration job to complete..."
        kubectl wait --for=condition=complete job -l app=flyway,environment=dev --timeout=300s
        
        echo "ğŸ“‹ Migration job results:"
        kubectl logs -l app=flyway,environment=dev --tail=100

    - name: ğŸ”„ Restart Express deployment
      if: success() && (github.event.inputs.force_restart != 'false')
      run: |
        echo "ğŸ”„ Restarting Express deployment to pick up schema changes..."
        kubectl rollout restart deployment/express-deployment
        kubectl rollout status deployment/express-deployment --timeout=300s
        echo "âœ… Express deployment restarted successfully"

    - name: âœ… Migration success notification
      if: success()
      run: |
        echo "ğŸ‰ DEV MIGRATION SUCCESSFUL!"
        echo "=========================="
        echo "âœ… Environment: DEV"
        echo "âœ… Database: Migrations applied"
        echo "âœ… Express: Restarted and healthy"
        echo "â° Completed: $(date)"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo ""
        echo "ğŸ§ª Ready for testing!"

  deploy-prod:
    needs: [detect-changes, validate-migrations]
    if: needs.detect-changes.outputs.migrations-changed == 'true' && needs.detect-changes.outputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš ï¸ Production migration warning
      run: |
        echo "âš ï¸  PRODUCTION DATABASE MIGRATION"
        echo "=================================="
        echo "ğŸ¯ Target: Production Database"
        echo "ğŸ“‹ Changes: $(git diff --name-only HEAD~1 HEAD | grep migrations/ || echo 'Manual trigger')"
        echo "â° Time: $(date)"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo ""
        echo "ğŸ” Please ensure this migration has been tested in DEV!"
        echo "â³ Waiting 10 seconds before proceeding..."
        sleep 10

    - name: âš™ï¸ Setup kubectl and doctl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        cd /tmp
        wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
        tar xf doctl-1.104.0-linux-amd64.tar.gz
        sudo mv doctl /usr/local/bin
        
        doctl auth init --access-token ${{ secrets.DO_API_TOKEN }}
        doctl kubernetes cluster kubeconfig save discbaboons-production

    - name: ğŸ’¾ Pre-migration backup check
      run: |
        echo "ğŸ’¾ Production backup verification..."
        echo "âš ï¸  TODO: Implement production backup verification"
        echo "ğŸ“Š Current production status:"
        kubectl get pods -l app=postgres --no-headers
        kubectl get configmap flyway-migrations -o yaml | grep -A 3 "data:" || echo "No migrations ConfigMap"

    - name: ğŸ—„ï¸ Update production migrations ConfigMap
      run: |
        echo "ğŸ“¦ Updating migrations ConfigMap in PRODUCTION..."
        kubectl delete configmap flyway-migrations --ignore-not-found=true
        kubectl create configmap flyway-migrations --from-file=migrations/
        echo "âœ… Production ConfigMap updated"

    - name: ğŸš€ Deploy production migration
      run: |
        echo "ğŸš€ Deploying migration in PRODUCTION environment..."
        
        cat << 'EOF' | kubectl apply -f -
        apiVersion: batch/v1
        kind: Job
        metadata:
          name: flyway-migration-prod-$(date +%s)
          labels:
            app: flyway
            environment: prod
            migration-run: "true"
        spec:
          ttlSecondsAfterFinished: 1200
          template:
            metadata:
              labels:
                app: flyway
                environment: prod
            spec:
              restartPolicy: Never
              containers:
              - name: flyway
                image: flyway/flyway:10.8.1
                command: ["/bin/sh"]
                args:
                  - -c
                  - |
                    echo "ğŸ” PRODUCTION migration starting..."
                    echo "Migration files available:"
                    ls -la /flyway/sql/
                    echo ""
                    echo "ğŸš€ Running Flyway migrate in PRODUCTION..."
                    flyway migrate
                    echo ""
                    echo "ğŸ“Š PRODUCTION migration status:"
                    flyway info
                env:
                - name: FLYWAY_URL
                  value: "jdbc:postgresql://postgres-service:5432/discbaboons_db"
                - name: FLYWAY_USER
                  value: "app_user"
                - name: FLYWAY_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: app-password-new
                - name: FLYWAY_LOCATIONS
                  value: "filesystem:/flyway/sql"
                - name: FLYWAY_BASELINE_ON_MIGRATE
                  value: "true"
                volumeMounts:
                - name: migrations
                  mountPath: /flyway/sql
              volumes:
              - name: migrations
                configMap:
                  name: flyway-migrations
        EOF
        
        kubectl wait --for=condition=complete job -l app=flyway,environment=prod --timeout=600s
        kubectl logs -l app=flyway,environment=prod --tail=100

    - name: ğŸ”„ Restart production Express
      if: success() && (github.event.inputs.force_restart != 'false')
      run: |
        echo "ğŸ”„ Restarting Express deployment in PRODUCTION..."
        kubectl rollout restart deployment/express-deployment
        kubectl rollout status deployment/express-deployment --timeout=300s
        echo "âœ… Production Express restarted successfully"

    - name: ğŸ‰ Production success notification
      if: success()
      run: |
        echo "ğŸ‰ PRODUCTION MIGRATION SUCCESSFUL!"
        echo "==================================="
        echo "âœ… Environment: PRODUCTION"
        echo "âœ… Database: V6 migration completed"
        echo "âœ… Express: Restarted and healthy" 
        echo "ğŸŒ Live: https://discbaboons.spirojohn.com"
        echo "â° Completed: $(date)"
        echo "ğŸ‘¤ By: ${{ github.actor }}"