name: Test & Verify

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: discbaboons_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/express-server/package-lock.json
          
      - name: Install dependencies
        working-directory: apps/express-server
        run: npm ci
        
      - name: Generate Prisma client
        working-directory: apps/express-server
        run: npm run db:generate
        
      - name: Run database migrations
        working-directory: apps/express-server
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/discbaboons_test
        run: |
          # Install Flyway CLI
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/10.8.1/flyway-commandline-10.8.1-linux-x64.tar.gz | tar -xvz
          sudo ln -s $(pwd)/flyway-10.8.1/flyway /usr/local/bin
          
          # Run migrations
          flyway -url=jdbc:postgresql://localhost:5432/discbaboons_test -user=testuser -password=testpassword -locations=filesystem:../../migrations migrate
        
      - name: Run tests
        working-directory: apps/express-server
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/discbaboons_test
          NODE_ENV: test
          FORCE_COLOR: true
        run: npm run verify
  deploy:   
    needs: test  
    if: github.ref == 'refs/heads/main'  # Only on main branch
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Login to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
    
    - name: ğŸ·ï¸ Generate image tag
      id: tag
      run: |
        # Create unique tag using git commit SHA
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        IMAGE_TAG="v7-${SHORT_SHA}"
        echo "Generated tag: ${IMAGE_TAG}"
        echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
    
    - name: ğŸ—ï¸ Build Docker image
      working-directory: apps/express-server
      run: |
        IMAGE_TAG="${{ steps.tag.outputs.tag }}"
        echo "Building: salokod/discbaboons-express:${IMAGE_TAG}"
        docker build -t salokod/discbaboons-express:${IMAGE_TAG} .
        
    - name: ğŸ“¤ Push to Docker Hub
      run: |
        IMAGE_TAG="${{ steps.tag.outputs.tag }}"
        echo "Pushing: salokod/discbaboons-express:${IMAGE_TAG}"
        docker push salokod/discbaboons-express:${IMAGE_TAG}
    
    - name: âš™ï¸ Setup kubectl and doctl
      run: |
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Install doctl
        cd /tmp
        wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
        tar xf doctl-1.104.0-linux-amd64.tar.gz
        sudo mv doctl /usr/local/bin
        
        # Authenticate and configure kubectl
        doctl auth init --access-token ${{ secrets.DO_API_TOKEN }}
        doctl kubernetes cluster kubeconfig save discbaboons-production
        
        # Test connection
        kubectl get nodes
        
    - name: ğŸš€ Deploy to Kubernetes
      run: |
        IMAGE_TAG="${{ steps.tag.outputs.tag }}"
        NEW_IMAGE="salokod/discbaboons-express:${IMAGE_TAG}"
        
        echo "ğŸš€ Deploying new image: ${NEW_IMAGE}"
        echo "ğŸ“ Current production image:"
        kubectl get deployment express-deployment -o jsonpath='{.spec.template.spec.containers[0].image}'
        echo ""
        
        # Update the deployment with new image
        kubectl set image deployment/express-deployment express=${NEW_IMAGE}
        
        # Wait for rollout to complete (5 minute timeout)
        echo "â³ Waiting for deployment to complete..."
        kubectl rollout status deployment/express-deployment --timeout=300s
        
        # Verify deployment success
        echo "âœ… Deployment completed! New pods:"
        kubectl get pods -l app=express -o wide
        
        echo "ğŸ¯ Verified new image in deployment:"
        kubectl get deployment express-deployment -o jsonpath='{.spec.template.spec.containers[0].image}'
        echo ""
        
        echo "ğŸŒ Your app is live at: https://discbaboons.spirojohn.com"
        
    - name: ğŸ“¢ Deployment Success Notification
      if: success()
      run: |
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo "=========================="
        echo "âœ… App: https://discbaboons.spirojohn.com"
        echo "ğŸ·ï¸ Image: salokod/discbaboons-express:${{ steps.tag.outputs.tag }}"
        echo "â° Time: $(date)"
        echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${{ github.event.head_commit.message }}"
        echo "ğŸ”— Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
    - name: ğŸš¨ Deployment Failure Alert
      if: failure()
      run: |
        echo "âŒ DEPLOYMENT FAILED!"
        echo "===================="
        echo "ğŸ” Check logs immediately: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ğŸ“§ Alert team for immediate investigation"
        echo "ğŸ”„ Consider emergency rollback if needed"